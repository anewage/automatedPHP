#!/bin/bash

if [ ! $# -eq 0 ] ; then
     # Run user cmd
    /cmd $@
    exit
fi
   
# Fix Permissions
mkdir -p /var/www/logs /var/www/tmp /var/www/.ssh
chmod g+w -R /var/www
chmod 700 -R /var/www/.ssh 
## chown may take long time so do it in background
chown -R www-data /var/www /root &

# persist Environment
echo "$WEBHOOK_SECRET" > /WEBHOOK_SECRET
echo `env` > /env

# Start www-data entrypoint and fork
sudo -E -u www-data -g www-data /entrypoint-www $@ &

# Start supervisord
echo "Starting supervisord"
/usr/bin/supervisord -c /etc/supervisord.conf 
