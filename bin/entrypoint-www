#!/bin/bash
source /env
cd /var/www

echo "Initializing www"

# Generate ssh key
if [ ! -f .ssh/id_rsa.pub ] ; then
 echo -e "\n\n\n" | ssh-keygen -t rsa -N "" -f .ssh/id_rsa -q

echo ----------------------------------------
 echo Public SSH Key is :
 echo ----------------------------------------
 cat .ssh/id_rsa.pub
echo ----------------------------------------

fi

# Remove lock file
if [ -f .paas.lock ] ; then
	rm .paas.lock
fi

# Clone git repo
if [ -z $GIT_REPO ] ; then
    echo "GIT_REPO is not set!"
    mkdir -vp src
else
    if [ ! -d src/.git ] ;then
        echo "Cloning git repo from $GIT_REPO"
        rm -r /tmp/src
        yes | GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git clone --recursive "$GIT_REPO" /tmp/src
		cp -rv /tmp/src ~
        rm -r /tmp/src

        # Execute update
        update

        # TODO
        # cat /env >> .env
    fi
fi

## Ensure Site is up
pushd src
if [ -f artisan ] ; then
    php artisan up
    echo "Artisan Up!"
fi
popd


# Webhook
if [ -d src/public ] ; then
    mkdir -p src/public
else
    ln -sv /var/www/src /var/www/src/public
fi

ln -fs /webhook.php /var/www/src/public
