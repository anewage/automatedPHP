#!/bin/bash

# Start nginx 
# nginx

# Generate ssh key
if [ ! -f ~/.ssh/id_rsa.pub ] ; then
 echo -e "\n\n\n" | ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa -q
 echo ----------------------------------------
 echo Your SSH Key is Ready
 echo ----------------------------------------
 cat ~/.ssh/id_rsa.pub
 echo ----------------------------------------
fi

# Check if data is not initialized yet
if [ ! -d /var/www/laravel ] ; then

	# Probe ssh-keys 
	ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
	ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts
	
	# Clone project
	if [ $# -ne 1 ]; then
		echo "illegal number of parameters, please specify git repo url"
		exit
	fi
	git clone --recursive $1 /var/www/laravel || exit

fi	

# Logs
touch /var/www/laravel/storage/logs/laravel.log 
ln -fs /var/www/laravel/storage/logs/laravel.log /var/www/logs

# Rotate All Logs
#for l in var/www/logs/* ; do
#	echo "" > $l
#done

# Laaser
mkdir -p /var/www/laravel/public && \
ln -fs /usr/share/laaser /var/www/laravel/public

# Let's Encrypt
cp -r /opt/letsencrypt /var/www

# Dist files
cp -r /opt/dist /var/www

# Remove lock file
if [ -f /var/www/laravel/.laas.lock ] ; then
	rm /var/www/laravel/.laas.lock
fi

# Update repo
update
