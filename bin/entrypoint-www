#!/bin/sh
HOME=/var/www
cd /var/www

# Generate ssh key
if [ ! -f /var/www/.ssh/id_rsa.pub ] ; then
 echo -e "\n\n\n" | ssh-keygen -t rsa -N "" -f /var/www/.ssh/id_rsa -q
fi

echo ----------------------------------------
 echo Public SSH Key is :
 echo ----------------------------------------
 cat /var/www/.ssh/id_rsa.pub
echo ----------------------------------------

# Check if data is not initialized yet
if [ ! -d /var/www/laravel ] ; then
    if [ -z $GIT_REPO ] ; then
        echo "ALERT: GIT_REPO IS NOT SET"
        mkdir -p /var/www/laravel
    else
    	# Clone project
    	yes | GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git clone --recursive $GIT_REPO /var/www/laravel
    fi
fi	

# Webhook
mkdir -p /var/www/laravel/public && \
ln -fs /webhook.php /var/www/laravel/public

# Remove lock file
if [ -f /var/www/laravel/.laas.lock ] ; then
	rm /var/www/laravel/.laas.lock
fi

# Execute cmd
if [ $# -eq 0 ] ; then
    echo "Executing update script..."
    /update
else
    cd /var/www/laravel && $@
fi
