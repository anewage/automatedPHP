#!/bin/bash

cd /var/www/laravel

## LOCK
if [ -f .laas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .laas.lock

# Do real update
git pull
composer install --prefer-source

# .laas_update file
if [ -f .laas_update] ; then
	source ./laas_update
fi

# Init
if [ ! -e .env ] ; then
  echo "**Installing default .env file**"
  cp -v .env.example .env
fi

# Re-Generate artisan key
php artisan key:generate

# Let's Encrypt
/var/www/letsencrypt/letsencrypt.sh --cron

## LOCK
rm .laas.lock
