#!/bin/sh

cd /var/www/laravel

## LOCK
if [ -f .laas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .laas.lock

# Set website to maintnance mode
php artisan down

# Do real update
yes | git pull

if [ -n $DEV ] ; then
    echo "## DEV MODE ##"
    composer install --prefer-source --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader
else
    composer install --prefer-source --no-ansi --no-dev --no-interaction --no-progress --no-scripts --optimize-autoloader
fi

# .webhookrc file
if [ -f /var/www/laravel/.webhookrc ] ; then
	/bin/bash -c /var/www/laravel/.webhookrc
fi

# Init
if [ ! -e .env ] ; then
  echo "**Installing default .env file**"
  cp -v .env.example .env
  # Re-Generate artisan key
  php artisan key:generate
fi

## Site UP
php artisan up

## LOCK
rm .laas.lock
