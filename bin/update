#!/bin/sh
HOME=/var/www
cd /var/www/laravel

## LOCK
if [ -f .laas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .laas.lock

# Set website to maintnance mode
php artisan down
echo "Artisan down!"

# Do real update
echo "Pulling git repo..."
yes | git pull
echo "--------------------------------------"

# Composer
echo "Installing composer dependencies..."
composer install --prefer-source --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader
echo "--------------------------------------"

# Npm
echo "Installing npm dependencies..." 
npm set progress=true
npm install
echo "--------------------------------------"

# .webhookrc file
if [ -f /var/www/laravel/.webhookrc ] ; then
	/bin/bash -c /var/www/laravel/.webhookrc
fi

# Init
if [ ! -e .env ] ; then
  echo "**Installing default .env file**"
  cp -v .env.example .env
  # Re-Generate artisan key
  php artisan key:generate
fi

## Site UP
php artisan up
echo "Artisan Up!"

## LOCK
rm .laas.lock
