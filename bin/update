#!/bin/sh

cd /var/www/laravel

## LOCK
if [ -f .laas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .laas.lock

# Do real update
git pull
composer install --prefer-source --no-ansi --no-dev --no-interaction --no-progress --no-scripts --optimize-autoloader
composer dump-autoload --optimize

# .laas_update file
if [ -f .laas_update ] ; then
	./laas_update
fi

# Init
if [ ! -e .env ] ; then
  echo "**Installing default .env file**"
  cp -v .env.example .env
  # Re-Generate artisan key
  php artisan key:generate
fi

## LOCK
rm .laas.lock
