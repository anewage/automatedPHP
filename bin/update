#!/bin/bash

cd /var/www/laravel

## LOCK
if [ -f .laas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .laas.lock

# Do real update
git pull
composer install --prefer-source

# .laas_update file
if [ -f .laas_update] ; then
	source ./laas_update
fi

# .nginx.conf file
render() {
 eval "echo \"$(cat $1|sed 's/\$/@#@/g;s/\%/\$/g')\"" | sed 's/@#@/\$/g'
}
NGINX_CONF=""
if [ -f .nginx.conf ] ; then
	NGINX_CONF="`cat .nginx.conf`"
fi
if [ -f .nginx.conf.extra ] ; then
	NGINX_CONF_EXTRA="`cat .nginx.conf.extra`"
fi
render /etc/nginx/nginx-default > /etc/nginx/sites-enabled/default.conf
nginx -s reload

# Init
if [ ! -e .env ] ; then
  echo "**Installing default .env file**"
  cp -v .env.example .env
fi

# Re-Generate artisan key
php artisan key:generate

# Let's Encrypt
/var/www/letsencrypt/letsencrypt.sh --cron

## LOCK
rm .laas.lock
