#!/bin/bash
source /env
HOME=/var/www
cd /var/www/src

## LOCK
if [ -f .paas.lock ] ; then
	echo "Lock file '.laas.lock' exists, it seems it is already updating ..."
	exit 1
fi
touch .paas.lock

# Set website to maintnance mode (laravel only)
if [ -f artisan ] ; then
    php artisan down
    echo "Artisan down!"
fi

# Do real update
if [ -f .git ] ; then
    echo "Pulling git repo..."
    git pull
fi

# Composer
if [ -f composer.json ] ; then
    echo "Installing composer dependencies..."
    composer install --prefer-source --no-ansi --no-interaction --no-progress --optimize-autoloader
fi

# .webhookrc file
if [ -f .webhookrc ] ; then
	/bin/bash -c /var/www/src/.webhookrc
fi

# .env
# TODO: (FIXME) merge and handle duplicates
cat /env >> .env

## Site UP
if [ -f artisan ] ; then
    php artisan up
    echo "Artisan Up!"
fi

## LOCK
rm .paas.lock
