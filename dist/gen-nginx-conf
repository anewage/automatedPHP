#!/bin/bash

SCRIPT=`realpath $0`
DIR=`dirname $SCRIPT`
DATADIR=`dirname $DIR`

OPTIND=1
SSL_CONF=""

# Parse Arguments
while getopts "?h:su:" opt; do
	case "$opt" in
		h)
			COMMONNAME=$OPTARG
			;;
		s)
			SSL_CONF="`cat $DIR/ssl.conf`"
			;;
		d)
			DATADIR=$OPTARG
			;;
		*)
			echo "Usage: $0 -h [common_name] -d [data_dir] {domains_list} -s ssl?"
			exit
			;;
	esac
done  	

[[ -z $COMMONNAME ]] && echo "-h [common_name] is missing" && exit

shift "$((OPTIND-1))"

DOMAINS=$@
SOCKETPATH=$DATADIR/nginx.sock
CERTPATH=$DATADIR/letsencrypt/certs/$COMMONNAME/fullchain.pem
KEYPATH=$DATADIR/letsencrypt/certs/$COMMONNAME/privkey.pem

# Add domains to ssl
echo "$COMMONNAME $DOMAINS" | sudo tee $DATADIR/letsencrypt/domains.txt

# Generate Nginx Configuration File
render() {
  eval "echo \"$(cat $1|sed 's/\$/#@#/g;s/\%/\$/g')\""|sed 's/#@#/\$/'
}
render $DIR/nginx.conf > $DIR/nginx.tmp
render $DIR/nginx.tmp | sudo tee /etc/nginx/sites-enabled/$COMMONNAME.conf
rm $DIR/nginx.tmp

echo "Reload Nginx.."
sudo nginx -s reload