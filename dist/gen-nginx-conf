#!/bin/bash

SCRIPT=`realpath $0`
DIR=`dirname $SCRIPT`
DATADIR=`dirname $DIR`

OPTIND=1
COMMONNAME=""
DOMAINS=""
SOCKETPATH=""
SSL_CONF=""

# Parse Arguments
while getopts "?h:su:" opt; do
	case "$opt" in
		h)
			COMMONNAME=$OPTARG
			;;
		s)
			SSL_CONF="`cat $DIR/ssl.conf`"
			;;
		d)
			DATADIR=$OPTARG
			;;
		*)
			echo "Usage: $0 -h [common_name] -d [data_dir] {domains_list}"
			exit
			;;
	esac
done  	

[[ -z $COMMONNAME ]] && echo "-h [common_name] is missing" && exit

shift "$((OPTIND-1))"

DOMAINS=$@
SOCKETPATH=$DATADIR/nginx.sock

# Add domains to ssl
tee "$COMMONNAME $DOMAINS" $DATADIR/letsencrypt/domains.txt


# Generate Nginx Configuration File
render_template() {
  eval "echo \"$(cat $1|sed 's/\$/#@#/g;s/\%/\$/g')\""|sed 's/#@#/\$/'
}
render_template $DIR/nginx.conf | sudo tee /etc/nginx/sites-enabled/$COMMONNAME.conf

echo "Reload Nginx.."
sudo nginx -s reload